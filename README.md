# ЛБ 1 Встраиваемые системы

Тема лабораторной работы:

## Знакомство с SPI. Применение библиотек при разработке ПО под STM32

### Цель работы

При помощи встроенного 3-х осевого акселерометра считать угол наклона отладочной платы STM32F407G-DISC1 и вывести его в виде маятника на светодиодную матрицу P10.


### Введение

Так как нужно использовать встроенный в отладочную плату акселерометр, необходимо изучить то, как произвести инициализацию акселерометра, и то, как получать данные с него в реальном времени.

### Общая информация об 3-х осевом акселерометре LSM303DLHC

LSM303DLHC - это система с цифровым датчиком линейного ускорения 3D и цифровым магнитным датчиком 3D в одном корпусе.
LSM303DLHC имеет полную шкалу линейного ускорения ±2g /±4g / ±8g /±16g и полную шкалу магнитного поля ±1.3 / ±1.9 / ±2.5 / ±4.0 / ±4.7 / ±5,6 / ±8,1 гаусс.

LSM303DLHC оснащен интерфейсом последовательной шины I2C, который поддерживает стандартный и быстрый режимы работы 100 кГц и 400 кГц. Система может быть сконфигурирована для генерации сигналов прерывания по событиям инерционного пробуждения/свободного падения, а также по положению самого устройства. Пороговые значения, время срабатывания, генераторы прерываний, пределы измерений, а соответственно и цена деления программируются конечным пользователем. Магнитный блок и блок акселерометра могут быть включены или переведены в режим отключения питания отдельно.
Именно так и поступим, включим только модуль акселерометра, настроим передачу данных на микроконтроллер при помощи интерфейса I2C.


<p align="center" width="100%">
    <img width="80%" src="./Images/image4.png">
</p>



<p align="center" width="100%">
    <img width="80%" src="./Images/Pasted%20image%2020240102224646.png">
</p>


```c
void TIM2_IRQHandler(void) // Периодическое прерывание, частота 500 Гц
{
 // Вычисление времени, которое кнопка находится в состояниях
 // "нажата" и "отпущена"
 
 if (Flag) { // Кнопка нажата
  HighTime = HAL_GetTick() - TimeStamp;
 } else { // Кнопка отпущена
  LowTime = HAL_GetTick() - TimeStamp;
 }
}
```



<p align="center" width="100%">
    <img width="80%" src="./Images/Pasted%20image%2020240104161022.png">
</p>

### Организация вывода на светодиодный модуль P10

Модуль P10 разделён на 4 зоны сканирования по 128 светодиодов в каждой. На рисунке ниже зоны обозначены цветами.

<p align="center" width="100%">
    <img width="100%" src="./Images/Pasted%20image%2020240105000601.png">
</p>

Каждая зона управляется 16 8-битными сдвиговыми регистрами с защелкой. Светодиоды подключены по матричной схеме, катоды светодиодов подключены к выходам сдвиговых регистров, а аноды через транзисторы подключены к линии питания, а также стянуты к земле, чтобы гарантировать нулевой потенциал на них при закрытых транзисторах.

На принципиальной схеме (ниже) видно, что для того, чтобы зажечь светодиод, необходимо, чтобы на выходе регистра (D1-D16), подключенного к катоду этого светодиода был логический ноль, а также должен быть открыт соответствующий нужной зоне MOSFET-транзистор (VT1-VT4).

<p align="center" width="100%">
    <img width="100%" src="./Images/Pasted%20image%2020240105000721.png">
</p>

Таким образом, управлять зоной сканирования модуля можно последовательно загружая данные в сдвиговые регистры (вход R), затем перенося их в регистры хранения путем активации защелки (вход SCLK). Текущая зона выбирается комбинацией логических уровней на входах модуля A и B. Вход OE используется для разрешения работы матрицы, а также управления её яркостью путем подачи ШИМ-сигнала на этот вход.

### Настройка SPI в STM32
Загружать данные в сдвиговые регистры можно с помощью встроенного в STM32 интерфейса SPI. Он использует для обмена данными те же принципы, что и сдвиговые регистры, используемые в модуле P10. Микроконтроллер выдает тактирование (CLK), по фронту которого периферийное устройство проверяет состояние шины данных (MOSI), загружая их в свой сдвиговый регистр.

Настройка SPI в STM32 CubeMX:

<p align="center" width="100%">
    <img width="70%" src="./Images/Pasted image 20240105165301.png">
</p>

Все настройки по умолчанию, изменим только Prescaler - установим максимальный, чтобы компоненты модуля P10 успевали переключаться между логическими уровнями. Если оставить частоту тактирования больше, модуль не функционирует корректно.

CubeMX автоматически определил выходы SPI (SPI1_SCK и SPI1_MOSI). Также определим ножку GPIO для разрешения работы модуля и управления яркостью (nOE).

<p align="center" width="100%">
    <img width="25%" src="./Images/Pasted image 20240105165859.png">
</p>

Для выбора текущей зоны назначим также два пина GPIO, которые будут подключены к входам A и B модуля, дадим им соответствующие имена.


<p align="center" width="100%">
    <img width="25%" src="./Images/Pasted image 20240105173931.png">
</p>

### Использование библиотеки для управления модулем

Использование библиотек позволяет значительно ускорить разработку программного обеспечения. Как правило библиотеки для STM32 состоят из пар заголовочных и исходных файлов языка Си. Заголовочные файлы содержат необходимые препроцессорные директивы, объявления типов данных и прототипы функций, а исходные файлы дополняют эти прототипы программным кодом.

В случае данной лабораторной работы была использована библиотека DMD для модуля P10. Её использование позволяет автоматизировать шаги, которые необходимо выполнить для работы матрицы.
Для отрисовки текста на матрицу перед кодом обновления экрана используются следующие функции:
```c
disp1color_FillScreenbuff(0);
disp1color_printf(2, 4, FONTID_6X8M, Text);
```
Первая очищает массив данных для исключения наложения старой и новой надписей. Вторая выводит текущее сообщение, хранящееся в строке "Text" моноширинным шрифтом размером 6x8 пикселей, отступив от левого нижнего угла 2 пикселя по горизонтали и 4 по вертикали. Результаты вывода текста на экран можно увидеть на рисунке ниже.


<p align="center" width="100%">
    <img width="80%" src="./Images/Pasted image 20240106174458.png">
</p>

### Результаты работы проекта

https://github.com/JV4K/Embedded-systems-LB1/assets/65915049/9598ffea-aa35-44c8-bc2f-0890058a5c46


